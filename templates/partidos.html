{% extends "base.html" %}
{% block title %}Partidos{% endblock %}

{% block content %}
<section class="hero reveal">
  <h1>Partidos</h1>
  <p>Consulta partidos jugados y pr√≥ximos, con estad√≠sticas acumuladas.</p>
</section>

<div class="section-title">Filtros</div>

<section class="cards">
  <article class="card">
    <input id="q" class="input" placeholder="Buscar rival, sede, liga..." />
  </article>

  <article class="card">
    <select id="color" class="select">
      <option value="">Equipo</option>
      {% for c in colores %}
        <option value="{{ c }}">{{ c }}</option>
      {% endfor %}
    </select>
  </article>

  <article class="card">
    <select id="res" class="select">
      <option value="">Resultado</option>
      <option value="Victoria">Victoria</option>
      <option value="Empate">Empate</option>
      <option value="Derrota">Derrota</option>
    </select>
  </article>

  <article class="card">
    <select id="liga" class="select">
      <option value="">Liga</option>
      {% for l in ligas %}
        <option value="{{ l }}">{{ l }}</option>
      {% endfor %}
    </select>
  </article>

  <article class="card">
    <select id="sede" class="select">
      <option value="">Sede</option>
      {% for s in sedes %}
        <option value="{{ s }}">{{ s }}</option>
      {% endfor %}
    </select>
  </article>
</section>

<div class="section-title">Partidos</div>

<section id="lista" class="cards">
  {% for p in partidos %}
    {% set marcador_txt = (p.marcador or '')|trim %}
    {% set is_upcoming = (marcador_txt == '') %}

    <article class="card partido {% if is_upcoming %}next-match{% endif %}"
      data-color="{{ p.equipo_color }}"
      data-res="{{ p.resultado }}"
      data-liga="{{ p.liga }}"
      data-sede="{{ p.sede }}"
      data-text="{{ (p.equipo ~ ' ' ~ p.rival ~ ' ' ~ p.fecha ~ ' ' ~ p.sede ~ ' ' ~ p.liga ~ ' ' ~ (p.marcador or '') ~ ' ' ~ (p.equipo_color or '') ~ ' ' ~ (p.resultado or '') ) | lower }}">

      <h3>{{ p.equipo }} vs {{ p.rival }}</h3>

      <div class="meta">
        <span class="pill">{{ p.liga }}</span>

        {% if is_upcoming %}
          <span class="badge-upcoming">‚è≥ Pr√≥ximo</span>
        {% else %}
          <span class="pill">{{ p.marcador }}</span>
        {% endif %}

        {% if p.resultado == "Victoria" %}
          <span class="chip win">Victoria</span>
        {% elif p.resultado == "Empate" %}
          <span class="chip draw">Empate</span>
        {% elif p.resultado == "Derrota" %}
          <span class="chip loss">Derrota</span>
        {% endif %}

        {% if p.mvp %}
          <span class="pill">üèÖ MVP: {{ p.mvp }}</span>
        {% endif %}
      </div>

      <p style="margin-top:8px; color:var(--muted);">
        <strong>Fecha:</strong> {{ p.fecha }}<br>
        <strong>Sede:</strong> {{ p.sede }}
      </p>

      <div class="buttons">
        <a class="btn secondary" href="/partidos/{{ p.id }}">Ver detalle</a>
      </div>
    </article>
  {% endfor %}

</section>

<p id="vacio" style="display:none; color:var(--muted); margin-top:12px;">
  No hay partidos con esos filtros.
</p>

<details class="accordion" style="margin-top:22px;">
  <summary>Estad√≠sticas acumuladas</summary>

  <div class="acc-body">
    <section class="match-grid" style="margin-top:12px;">

      <!-- LEADERBOARD -->
      <article class="card">
        <div class="section-title">Leaderboard ¬∑ Jugadores</div>

        <table id="tabla-jugadores" class="events">
          <thead>
            <tr>
              <th data-type="text">Jugador</th>
              <th data-type="num">PJ</th>
              <th data-type="num">Goles</th>
              <th data-type="num">Asistencias</th>
              <th data-type="num">MVPs</th>
              <th data-type="num">Total</th>
            </tr>
          </thead>
          <tbody>
            {% for r in leaderboard %}
              <tr>
                <td>{{ r.jugador }}</td>
                <td>{{ r.pj }}</td>
                <td>{{ r.goles }}</td>
                <td>{{ r.asistencias }}</td>
                <td>{{ r.mvps }}</td>
                <td><strong>{{ "%.1f"|format(r.total) }}</strong></td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </article>

      <!-- PORTEROS -->
      <article class="card">
        <div class="section-title">Porteros ¬∑ Goles recibidos</div>

        {% if porteros_tabla %}
          <table class="events">
            <thead>
              <tr>
                <th>Portero</th>
                <th>Goles recibidos</th>
              </tr>
            </thead>
            <tbody>
              {% for r in porteros_tabla %}
                <tr>
                  <td>{{ r.portero }}</td>
                  <td>{{ r.goles_recibidos }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p style="color:var(--muted);">Sin datos.</p>
        {% endif %}
      </article>

      <!-- GOLEADORES -->
      <article class="card">
        <div class="section-title">Goleadores</div>

        {% if goles_top %}
          <table class="events">
            <thead>
              <tr>
                <th>Jugador</th>
                <th>Goles</th>
              </tr>
            </thead>
            <tbody>
              {% for nombre, n in goles_top %}
                <tr>
                  <td>{{ nombre }}</td>
                  <td>{{ n }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p style="color:var(--muted);">Sin datos.</p>
        {% endif %}
      </article>

      <!-- ASISTENCIAS -->
      <article class="card">
        <div class="section-title">Asistencias</div>

        {% if asist_top %}
          <table class="events">
            <thead>
              <tr>
                <th>Jugador</th>
                <th>Asistencias</th>
              </tr>
            </thead>
            <tbody>
              {% for nombre, n in asist_top %}
                <tr>
                  <td>{{ nombre }}</td>
                  <td>{{ n }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p style="color:var(--muted);">Sin datos.</p>
        {% endif %}
      </article>

      <!-- MVPS -->
      <article class="card">
        <div class="section-title">MVPs</div>

        {% if mvps_top %}
          <table class="events">
            <thead>
              <tr>
                <th>Jugador</th>
                <th>MVPs</th>
              </tr>
            </thead>
            <tbody>
              {% for nombre, n in mvps_top %}
                <tr>
                  <td>{{ nombre }}</td>
                  <td>{{ n }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          <p style="color:var(--muted);">Sin datos.</p>
        {% endif %}
      </article>

    </section>
  </div>
</details>

<script>
(function(){
  const q = document.getElementById("q");
  const color = document.getElementById("color");
  const res = document.getElementById("res");
  const liga = document.getElementById("liga");
  const sede = document.getElementById("sede");

  const cards = Array.from(document.querySelectorAll(".partido"));
  const vacio = document.getElementById("vacio");

  function filtrar(){
    const query = (q.value || "").trim().toLowerCase();
    const colorVal = color.value || "";
    const resVal = res.value || "";
    const ligaVal = liga.value || "";
    const sedeVal = sede.value || "";

    let shown = 0;
    for (const c of cards){
      const okColor = !colorVal || c.dataset.color === colorVal;
      const okRes   = !resVal   || c.dataset.res === resVal;
      const okLiga  = !ligaVal  || c.dataset.liga === ligaVal;
      const okSede  = !sedeVal  || c.dataset.sede === sedeVal;
      const okTxt   = !query    || (c.dataset.text || "").includes(query);

      const ok = okColor && okRes && okLiga && okSede && okTxt;
      c.style.display = ok ? "" : "none";
      if (ok) shown++;
    }
    vacio.style.display = shown ? "none" : "";
  }

  q.addEventListener("input", filtrar);
  [color, res, liga, sede].forEach(el => el.addEventListener("change", filtrar));

  filtrar();
})();
</script>

<script>
(function(){

  function parseCell(td, type){
    const txt = (td.textContent || "").trim();
    if(type === "num"){
      const n = parseFloat(txt);
      return isNaN(n) ? 0 : n;
    }
    return txt.toLowerCase();
  }

  function makeSortable(tableId){
    const table = document.getElementById(tableId);
    if(!table) return;

    const thead = table.querySelector("thead");
    const tbody = table.querySelector("tbody");

    const headers = Array.from(thead.querySelectorAll("th"));
    let currentCol = null;
    let dir = 1;

    headers.forEach((th, idx) => {
      th.style.cursor = "pointer";

      th.addEventListener("click", () => {
        const type = th.dataset.type || "text";

        dir = (currentCol === idx) ? -dir : 1;
        currentCol = idx;

        const rows = Array.from(tbody.querySelectorAll("tr"));

        rows.sort((a,b) => {
          const aVal = parseCell(a.children[idx], type);
          const bVal = parseCell(b.children[idx], type);

          if(aVal < bVal) return -1 * dir;
          if(aVal > bVal) return  1 * dir;
          return 0;
        });

        rows.forEach(r => tbody.appendChild(r));
      });
    });
  }

  makeSortable("tabla-jugadores");

})();
</script>
{% endblock %}